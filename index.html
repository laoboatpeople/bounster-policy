<script>
(function () {
  const gallery = document.getElementById('gallery');
  const dotsWrap = document.getElementById('gallery-dots');
  const phonePreview = gallery.closest('.phone-preview');
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  const slides = () => Array.from(gallery.querySelectorAll('img'));
  let index = 0;

  // --- helpers
  const mod = (n, m) => ((n % m) + m) % m;

  function goTo(i, smooth = true) {
    const n = slides().length;
    index = mod(i, n);
    gallery.scrollTo({ left: index * gallery.clientWidth, behavior: smooth ? 'smooth' : 'auto' });
    updateDots();
  }

  // --- arrows API
  window.scrollGallery = function (dir) {
    const current = Math.round(gallery.scrollLeft / gallery.clientWidth);
    goTo(current + (dir > 0 ? 1 : -1));
  };

  // --- dots
  function renderDots() {
    dotsWrap.innerHTML = '';
    slides().forEach((_, i) => {
      const b = document.createElement('button');
      b.className = 'dot';
      b.type = 'button';
      b.setAttribute('aria-label', `Aller à l’image ${i + 1}`);
      b.addEventListener('click', () => {
        stopAuto(); // l’utilisateur a interagi, on pause
        goTo(i);
      });
      dotsWrap.appendChild(b);
    });
    updateDots();
  }

  function updateDots() {
    const dots = Array.from(dotsWrap.children);
    dots.forEach((d, i) => d.classList.toggle('active', i === index));
  }

  // --- resize: garder la diapo courante
  window.addEventListener('resize', () => goTo(index, false));

  // --- clavier
  gallery.setAttribute('tabindex', '0');
  gallery.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight') { e.preventDefault(); stopAuto(); window.scrollGallery(1); }
    if (e.key === 'ArrowLeft')  { e.preventDefault(); stopAuto(); window.scrollGallery(-1); }
  });

  // --- snap après scroll manuel
  let scrollTimeout;
  gallery.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const current = Math.round(gallery.scrollLeft / gallery.clientWidth);
      index = current;
      updateDots();
    }, 120);
  });

  // --- auto-slide
  const INTERVAL = 3500;
  let timer = null;
  function startAuto() {
    if (prefersReduced || timer) return;
    timer = setInterval(() => window.scrollGallery(1), INTERVAL);
  }
  function stopAuto() {
    if (timer) clearInterval(timer);
    timer = null;
  }

  // pause sur survol/focus et onglet caché
  ['mouseenter','focusin','touchstart'].forEach(ev => phonePreview.addEventListener(ev, stopAuto));
  ['mouseleave','focusout','touchend'].forEach(ev => phonePreview.addEventListener(ev, startAuto));
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) stopAuto(); else startAuto();
  });

  // init
  renderDots();
  goTo(0, false);
  startAuto();
})();
</script>
